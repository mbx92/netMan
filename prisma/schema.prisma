// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// SITE / BUILDING MANAGEMENT
// ============================================

model Site {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  location    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  devices         Device[]
  mikrotikDevices MikrotikDevice[]
  ipRanges        IPRange[]
}

// ============================================
// DEVICE MANAGEMENT
// ============================================

// Device Type Master Data
model DeviceType {
  id              String    @id @default(uuid())
  code            String    @unique  // e.g., "SWITCH_MANAGED"
  name            String              // e.g., "Managed Switch"
  icon            String?             // Icon name for UI
  color           String?             // Color hex for UI
  isNetworkDevice Boolean   @default(false)  // Shows port management
  canHavePorts    Boolean   @default(false)  // Can add ports
  topologyTier    Int       @default(2)      // 0=router, 1=switch/AP, 2=end device
  sortOrder       Int       @default(0)      // Display order in dropdowns
  isActive        Boolean   @default(true)   // Soft delete
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  devices         Device[]
}

model Device {
  id        String       @id @default(uuid())
  name      String
  typeCode  String       // References DeviceType.code (e.g., "SWITCH_MANAGED")
  ip        String?
  mac       String?      @unique
  hostname  String?
  floor     String?      // Floor number/name
  location  String?
  status    DeviceStatus @default(UNKNOWN)
  lastSeen  DateTime?
  owner     String?
  notes     String?
  wakeable  Boolean      @default(false)
  isManaged Boolean      @default(true)  // For unmanaged switches (no ping)
  portCount Int?         // Number of physical ports (for switches/routers)
  
  // MikroTik/Router API credentials (only for ROUTER type)
  apiPort     Int?       // e.g., 8728
  apiUser     String?
  apiPass     String?    // Should be encrypted in production
  apiVersion  String?    // "v6" or "v7"
  isApiActive Boolean    @default(false)
  lastApiSync DateTime?
  
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Site relation
  siteId    String?
  site      Site?        @relation(fields: [siteId], references: [id])
  
  // Device type relation
  deviceType DeviceType? @relation(fields: [typeCode], references: [code])

  // Parent device relation (for VMs linked to hypervisor host)
  parentDeviceId String?
  parentDevice   Device?   @relation("DeviceHierarchy", fields: [parentDeviceId], references: [id], onDelete: SetNull)
  childDevices   Device[]  @relation("DeviceHierarchy")

  ports          NetworkPort[]   @relation("DevicePorts") // Ports ON this device
  connectedPorts NetworkPort[]   @relation("PortConnections") // Ports this device is connected TO
  sessions       RemoteSession[]

  @@index([typeCode])
  @@index([status])
  @@index([floor])
  @@index([location])
  @@index([siteId])
  @@index([parentDeviceId])
}

enum DeviceStatus {
  ONLINE
  OFFLINE
  UNKNOWN
  MAINTENANCE
}

// ============================================
// NETWORK PORT TRACKING
// ============================================

model NetworkPort {
  id          String     @id @default(uuid())
  deviceId    String // Parent switch/router ID
  portName    String // e.g., "eth1", "ether1"
  portNumber  Int? // Physical port number (1, 2, 3...)
  vlan        String?
  speed       String?
  status      PortStatus @default(DOWN)
  macLearned  String[]
  description String?

  // Connected device assignment
  connectedDeviceId String? // Device connected to this port
  connectedDevice   Device? @relation("PortConnections", fields: [connectedDeviceId], references: [id], onDelete: SetNull)

  device Device @relation("DevicePorts", fields: [deviceId], references: [id], onDelete: Cascade)

  @@unique([deviceId, portName])
  @@index([connectedDeviceId])
}

enum PortStatus {
  UP
  DOWN
  DISABLED
}

// ============================================
// REMOTE ACCESS SESSION LOGGING
// ============================================

model RemoteSession {
  id        String         @id @default(uuid())
  user      String
  targetId  String
  protocol  RemoteProtocol
  startedAt DateTime       @default(now())
  endedAt   DateTime?
  notes     String?
  target    Device         @relation(fields: [targetId], references: [id], onDelete: Cascade)

  @@index([user])
  @@index([targetId])
}

enum RemoteProtocol {
  SSH
  RDP
  VNC
  CONSOLE
  HTTP
}

// ============================================
// AUDIT TRAIL
// ============================================

model AuditLog {
  id        String   @id @default(uuid())
  actor     String
  action    String
  target    String
  details   Json?
  result    String
  createdAt DateTime @default(now())

  @@index([actor])
  @@index([action])
  @@index([createdAt])
}

// ============================================
// IP ADDRESS MANAGEMENT (IPAM)
// ============================================

model IPRange {
  id          String         @id @default(uuid())
  name        String
  network     String // e.g., "192.168.1.0/24"
  gateway     String?
  vlan        String?
  description String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  allocations IPAllocation[]

  // Site relation
  siteId      String?
  site        Site?          @relation(fields: [siteId], references: [id])

  @@unique([siteId, network])
  @@index([siteId])
}

model IPAllocation {
  id        String         @id @default(uuid())
  rangeId   String
  ip        String
  mac       String?
  hostname  String?
  type      AllocationType
  createdAt DateTime       @default(now())
  range     IPRange        @relation(fields: [rangeId], references: [id], onDelete: Cascade)

  @@unique([rangeId, ip])
}

enum AllocationType {
  STATIC
  DHCP
  RESERVED
}

// ============================================
// MIKROTIK CREDENTIALS
// ============================================

model MikrotikDevice {
  id         String    @id @default(uuid())
  name       String
  host       String
  port       Int       @default(8728)
  username   String
  password   String    // Should be encrypted in production
  apiVersion String    @default("v6") // "v6" (API protocol) or "v7" (REST API)
  isActive   Boolean   @default(true)
  lastSync   DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Site relation
  siteId     String?
  site       Site?     @relation(fields: [siteId], references: [id])

  @@unique([host, port])
  @@index([siteId])
}
